<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¬ Live Chat - Charlie's Site</title>
    <link rel="stylesheet" href="elements.css">
    <style>
        .chat-container {
            max-width: 800px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.8);
            border: 3px ridge #00ffff;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(to right, #ff00ff, #00ffff);
            padding: 15px;
            text-align: center;
            border-bottom: 3px ridge #ffff00;
        }
        
        .chat-header h2 {
            margin: 0;
            color: #000;
            text-shadow: 1px 1px #fff;
        }
        
        .online-count {
            background: #00ff00;
            color: #000;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #000;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.own-message {
            background: rgba(255, 255, 0, 0.1);
            border-left-color: #ffff00;
        }
        
        .chat-message.charlie-message {
            background: rgba(255, 0, 255, 0.2);
            border-left-color: #ff00ff;
            border-width: 4px;
        }
        
        .message-author {
            font-weight: bold;
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .charlie-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .message-text {
            color: #fff;
            font-size: 15px;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
        }
        
        .chat-input-area {
            padding: 15px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 3px ridge #00ff00;
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex: 1;
            padding: 12px;
            background: #000;
            border: 3px inset #00ffff;
            color: #00ff00;
            font-family: "Comic Sans MS", Arial;
            font-size: 14px;
            border-radius: 5px;
        }
        
        #send-btn {
            padding: 12px 25px;
            background: linear-gradient(to bottom, #00ff00, #00cc00);
            color: #000;
            border: 3px outset #fff;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }
        
        #send-btn:active {
            border: 3px inset #fff;
        }
        
        .username-setup {
            padding: 20px;
            text-align: center;
        }
        
        #username-input {
            width: 200px;
            margin: 10px;
        }
        
        .typing-indicator {
            padding: 10px 15px;
            color: #888;
            font-style: italic;
            font-size: 13px;
        }
    </style>
</head>
<body>

<div class="wrapper">
    <h1>ğŸ’¬ Live Chat</h1>
    <marquee behavior="alternate" scrollamount="5">
        ğŸŒ REAL-TIME CHAT ğŸŒ TALK TO VISITORS ğŸŒ 90s IRC VIBES ğŸŒ
    </marquee>
    
    <p class="blink">Chat with other visitors in real-time!</p>
    
    <!-- Username Setup (shown first) -->
    <div id="username-setup" class="username-setup">
        <h2 style="color: #00ffff;">Choose Your Chat Name:</h2>
        <input type="text" id="username-input" placeholder="Enter username..." maxlength="20">
        <br>
        <button class="button" onclick="setUsername()">ğŸš€ Join Chat</button>
    </div>
    
    <!-- Chat Container (hidden until username set) -->
    <div id="chat-container" class="chat-container" style="display: none;">
        <div class="chat-header">
            <h2>ğŸ’¬ Charlie's Chat Room</h2>
            <div class="online-count">
                ğŸŸ¢ <span id="online-count">1</span> online
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- Messages appear here -->
        </div>
        
        <div class="typing-indicator" id="typing-indicator" style="display: none;">
            <span class="blink">Someone is typing...</span>
        </div>
        
        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Type a message..." 
                    maxlength="200"
                    disabled
                >
                <button id="send-btn" onclick="sendMessage()" disabled>
                    ğŸ“¤ Send
                </button>
            </div>
            <p style="font-size: 11px; color: #888; margin-top: 8px; text-align: center;">
                Messages are public and moderated. Be respectful! ğŸ¤
            </p>
        </div>
    </div>
    
    <div class="box" style="margin-top: 20px;">
        <h3>ğŸ’¡ Chat Tips:</h3>
        <ul style="list-style: none; padding: 0;">
            <li style="border: none;">âœ… Be friendly and respectful</li>
            <li style="border: none;">âœ… Chat is moderated for profanity</li>
            <li style="border: none;">âœ… Messages are public to all visitors</li>
            <li style="border: none;">âœ… Charlie might pop in to say hi! ğŸ‘‹</li>
        </ul>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
        <a class="button" href="index.html">ğŸ  Back to Homepage</a>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
   apiKey: "AIzaSyAVLUuQhdJ8Co80X4k8YylvrzRAM1bPTXs",
  authDomain: "charlie-guestbook.firebaseapp.com",
  databaseURL: "https://charlie-guestbook-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "charlie-guestbook",
  storageBucket: "charlie-guestbook.firebasestorage.app",
  messagingSenderId: "40421298596",
  appId: "1:40421298596:web:0426fdef8f4f3b1c1b3131"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const chatRef = database.ref('chat');
const presenceRef = database.ref('presence');

let myUsername = '';
let myUserId = '';
let typingTimeout = null;

// Set Username
function setUsername() {
    const input = document.getElementById('username-input');
    const username = input.value.trim();
    
    if (username.length < 2) {
        alert('âš ï¸ Username must be at least 2 characters!');
        return;
    }
    
    if (username.length > 20) {
        alert('âš ï¸ Username too long! Max 20 characters.');
        return;
    }
    
    myUsername = username;
    myUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Save to localStorage
    localStorage.setItem('chatUsername', myUsername);
    localStorage.setItem('chatUserId', myUserId);
    
    // Show chat, hide setup
    document.getElementById('username-setup').style.display = 'none';
    document.getElementById('chat-container').style.display = 'block';
    document.getElementById('chat-input').disabled = false;
    document.getElementById('send-btn').disabled = false;
    
    // Set up presence
    setupPresence();
    
    // Load messages
    loadMessages();
    
    // Focus input
    document.getElementById('chat-input').focus();
}

// Setup Presence Tracking
function setupPresence() {
    const myPresenceRef = presenceRef.child(myUserId);
    
    // Set user as online
    myPresenceRef.set({
        username: myUsername,
        online: true,
        lastSeen: Date.now()
    });
    
    // Remove on disconnect
    myPresenceRef.onDisconnect().remove();
    
    // Count online users
    presenceRef.on('value', (snapshot) => {
        const count = snapshot.numChildren();
        document.getElementById('online-count').textContent = count;
    });
}

// Send Message
function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (message.length > 200) {
        alert('âš ï¸ Message too long! Max 200 characters.');
        return;
    }
    
    // Check cooldown
    const lastMessage = localStorage.getItem('lastChatMessage');
    if (lastMessage) {
        const timeSince = Date.now() - parseInt(lastMessage);
        if (timeSince < 2000) { // 2 second cooldown
            alert('â° Slow down! Wait a moment between messages.');
            return;
        }
    }
    
    const chatMessage = {
        username: myUsername,
        userId: myUserId,
        message: message,
        timestamp: Date.now()
    };
    
    chatRef.push(chatMessage);
    
    input.value = '';
    localStorage.setItem('lastChatMessage', Date.now().toString());
}

// Load Messages
function loadMessages() {
    chatRef.orderByChild('timestamp').limitToLast(50).on('child_added', (snapshot) => {
        const data = snapshot.val();
        displayMessage(data);
    });
}

// Display Message
function displayMessage(data) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    
    const isOwnMessage = data.userId === myUserId;
    const isCharlie = data.username.toLowerCase().includes('charlie');
    
    messageDiv.className = 'chat-message';
    if (isOwnMessage) messageDiv.className += ' own-message';
    if (isCharlie) messageDiv.className += ' charlie-message';
    
    const time = new Date(data.timestamp).toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const charlieBadge = isCharlie ? '<span class="charlie-badge">ğŸ‘‘ CHARLIE</span>' : '';
    
    messageDiv.innerHTML = `
        <div class="message-author">${escapeHtml(data.username)}${charlieBadge}</div>
        <div class="message-text">${escapeHtml(data.message)}</div>
        <div class="message-time">${time}</div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Enter key to send
document.addEventListener('DOMContentLoaded', () => {
    const usernameInput = document.getElementById('username-input');
    const chatInput = document.getElementById('chat-input');
    
    usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') setUsername();
    });
    
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    
    // Check for saved username
    const savedUsername = localStorage.getItem('chatUsername');
    const savedUserId = localStorage.getItem('chatUserId');
    
    if (savedUsername && savedUserId) {
        myUsername = savedUsername;
        myUserId = savedUserId;
        document.getElementById('username-setup').style.display = 'none';
        document.getElementById('chat-container').style.display = 'block';
        document.getElementById('chat-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        setupPresence();
        loadMessages();
    }
});

// Clean up old messages (keep last 100)
setInterval(() => {
    chatRef.orderByChild('timestamp').limitToLast(100).once('value', (snapshot) => {
        const count = snapshot.numChildren();
        if (count > 100) {
            chatRef.orderByChild('timestamp').limitToFirst(count - 100).once('value', (oldSnap) => {
                oldSnap.forEach((child) => {
                    child.ref.remove();
                });
            });
        }
    });
}, 60000); // Check every minute
</script>

<script src="mouse-trail.js"></script>

</body>
</html>
